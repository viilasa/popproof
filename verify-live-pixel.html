<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProofPop Live Pixel Verification</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #1a202c;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #718096;
            margin-bottom: 30px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2d3748;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }
        
        .result {
            margin-top: 30px;
            padding: 20px;
            border-radius: 8px;
            display: none;
        }
        
        .result.success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            display: block;
        }
        
        .result.error {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            display: block;
        }
        
        .result.warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            display: block;
        }
        
        .result h3 {
            margin-bottom: 10px;
        }
        
        .result ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .result li {
            margin-bottom: 5px;
        }
        
        .code-block {
            background: #1a202c;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            margin-top: 15px;
            overflow-x: auto;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .correct-code {
            background: #f7fafc;
            border: 2px solid #10b981;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .correct-code h4 {
            color: #065f46;
            margin-bottom: 10px;
        }
        
        .correct-code code {
            background: #1a202c;
            color: #10b981;
            padding: 10px;
            display: block;
            border-radius: 4px;
            font-size: 12px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç ProofPop Live Pixel Verification</h1>
        <p class="subtitle">Verify your pixel is correctly installed on your live website</p>
        
        <div class="input-group">
            <label for="siteId">Your Site ID:</label>
            <input type="text" id="siteId" placeholder="e.g., 1808e26c-e195-4fcf-8eb1-95a4be718b39" value="1808e26c-e195-4fcf-8eb1-95a4be718b39">
        </div>
        
        <div class="input-group">
            <label for="websiteUrl">Your Website URL:</label>
            <input type="url" id="websiteUrl" placeholder="https://yourwebsite.com">
        </div>
        
        <button onclick="verifyPixel()" id="verifyBtn">üöÄ Verify Pixel Installation</button>
        
        <div id="result" class="result"></div>
    </div>
    
    <script>
        async function verifyPixel() {
            const siteId = document.getElementById('siteId').value.trim();
            const websiteUrl = document.getElementById('websiteUrl').value.trim();
            const resultDiv = document.getElementById('result');
            const verifyBtn = document.getElementById('verifyBtn');
            
            // Validation
            if (!siteId) {
                showResult('error', 'Missing Site ID', 'Please enter your Site ID');
                return;
            }
            
            if (!websiteUrl) {
                showResult('error', 'Missing Website URL', 'Please enter your website URL');
                return;
            }
            
            // Show loading
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Verifying...';
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>Checking your pixel installation...</p></div>';
            resultDiv.className = 'result';
            resultDiv.style.display = 'block';
            
            try {
                // Step 1: Check if edge functions are deployed
                const functionsCheck = await checkEdgeFunctions();
                
                // Step 2: Fetch the website and check for pixel code
                const pixelCheck = await checkPixelOnWebsite(websiteUrl, siteId);
                
                // Step 3: Check database for verification
                const dbCheck = await checkDatabaseVerification(siteId);
                
                // Display results
                displayResults(functionsCheck, pixelCheck, dbCheck, siteId);
                
            } catch (error) {
                showResult('error', 'Verification Failed', error.message);
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'üöÄ Verify Pixel Installation';
            }
        }
        
        async function checkEdgeFunctions() {
            const baseUrl = 'https://ghiobuubmnvlaukeyuwe.supabase.co/functions/v1';
            const results = {
                pixelLoader: false,
                engine: false,
                verifyPixel: false,
                trackEvent: false
            };
            
            try {
                const response = await fetch(`${baseUrl}/pixel-loader`);
                results.pixelLoader = response.ok;
            } catch (e) {
                results.pixelLoader = false;
            }
            
            try {
                const response = await fetch(`${baseUrl}/engine`);
                results.engine = response.ok;
            } catch (e) {
                results.engine = false;
            }
            
            return results;
        }
        
        async function checkPixelOnWebsite(url, siteId) {
            try {
                // Try to fetch the website (will fail due to CORS, but that's okay)
                const response = await fetch(url, { mode: 'no-cors' });
                
                // We can't actually read the content due to CORS, so we'll provide instructions
                return {
                    canCheck: false,
                    message: 'Cannot automatically check due to CORS. Please verify manually.'
                };
            } catch (error) {
                return {
                    canCheck: false,
                    message: 'Cannot automatically check due to CORS. Please verify manually.'
                };
            }
        }
        
        async function checkDatabaseVerification(siteId) {
            // This would require Supabase client, so we'll skip for now
            return {
                checked: false,
                message: 'Check your Supabase dashboard for verification records'
            };
        }
        
        function displayResults(functionsCheck, pixelCheck, dbCheck, siteId) {
            const allFunctionsOk = functionsCheck.pixelLoader && functionsCheck.engine;
            
            let html = '';
            
            if (allFunctionsOk) {
                html += '<h3 style="color: #065f46;">‚úÖ Edge Functions are Deployed!</h3>';
                html += '<ul>';
                html += '<li>‚úÖ pixel-loader is working</li>';
                html += '<li>‚úÖ engine is working</li>';
                html += '</ul>';
            } else {
                html += '<h3 style="color: #dc2626;">‚ùå Edge Functions Not Deployed</h3>';
                html += '<p>You need to deploy your edge functions first:</p>';
                html += '<div class="code-block">npx supabase functions deploy</div>';
                showResult('error', 'Deployment Required', html);
                return;
            }
            
            html += '<div class="correct-code">';
            html += '<h4>‚úÖ Correct Pixel Code to Use:</h4>';
            html += '<code>&lt;!-- ProofPop Pixel Code --&gt;<br>';
            html += `&lt;script src="https://ghiobuubmnvlaukeyuwe.supabase.co/functions/v1/pixel-loader" data-site-id="${siteId}" async defer&gt;&lt;/script&gt;<br>`;
            html += '&lt;!-- END ProofPop Pixel Code --&gt;</code>';
            html += '</div>';
            
            html += '<h3 style="margin-top: 20px;">üìã Manual Verification Steps:</h3>';
            html += '<ol style="margin-left: 20px; margin-top: 10px;">';
            html += '<li>Copy the pixel code above</li>';
            html += '<li>Add it to your website\'s &lt;head&gt; section</li>';
            html += '<li>Visit your website</li>';
            html += '<li>Open browser console (F12)</li>';
            html += '<li>Look for these messages:</li>';
            html += '<div class="code-block" style="margin: 10px 0;">';
            html += 'ProofPop: Pixel Loader v2.0 initialized<br>';
            html += 'ProofPop: Pixel verification successful<br>';
            html += 'ProofPop: Engine loaded successfully';
            html += '</div>';
            html += '<li>Check your Supabase dashboard ‚Üí sites table ‚Üí last_ping should be recent</li>';
            html += '</ol>';
            
            html += '<h3 style="margin-top: 20px;">üîç Check Database:</h3>';
            html += '<p>Run this query in Supabase SQL Editor:</p>';
            html += '<div class="code-block">';
            html += `SELECT verification_status, last_ping, verified<br>`;
            html += `FROM sites<br>`;
            html += `WHERE id = '${siteId}';`;
            html += '</div>';
            
            showResult('success', 'Verification Instructions', html);
        }
        
        function showResult(type, title, content) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `<h3>${title}</h3><div>${content}</div>`;
            resultDiv.style.display = 'block';
        }
    </script>
</body>
</html>
